


<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–“éš”é‡è¤‡å–®å­—åŠ©æ‰‹ (å„ªåŒ–ç‰ˆ)</title>
    <style>
        /* CSS æ¨£å¼ (ä¿ç•™å¤§éƒ¨åˆ†åŸå§‹è¨­è¨ˆï¼Œåƒ…å¾®èª¿) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #007bff;
        }

        .container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* ä»‹é¢åˆ‡æ› */
        #home-page, #quiz-page, #edit-page {
            display: none; /* é è¨­å…¨éƒ¨éš±è—ï¼Œç”± JS æ§åˆ¶é¡¯ç¤º */
        }
        #home-page {
            display: block; /* é è¨­é¡¯ç¤ºé¦–é  */
        }

        /* å–®å­—é›†ç®¡ç† */
        #set-management {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        #custom-set-input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px 0 0 4px;
            width: 60%;
            box-sizing: border-box; /* å„ªåŒ–ä½ˆå±€ */
        }

        #add-custom-set-btn {
            padding: 8px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #add-custom-set-btn:hover {
            background-color: #218838;
        }

        .word-set-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }

        .word-set-list li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .word-set-list li:last-child {
            border-bottom: none;
        }

        .set-name-display {
            flex-grow: 1;
            margin-left: 10px;
        }

        .edit-set-btn, .delete-set-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.9em;
        }

        .delete-set-btn {
            color: #dc3545;
        }

        /* çµ±è¨ˆèˆ‡é–‹å§‹æŒ‰éˆ• */
        #today-count {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffc107;
            margin: 20px 0;
            text-align: center;
        }

        #start-quiz-btn {
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 1.5em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #start-quiz-btn:hover {
            background-color: #0056b3;
        }

        #start-quiz-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* å–®å­—å¡ä»‹é¢ */
        #quiz-page {
            text-align: center;
        }
        .word-card {
            background: #fff;
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 40px 20px;
            margin-bottom: 20px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .word-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.2);
        }

        .card-front {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }

        .card-back {
            font-size: 1.5em;
            color: #666;
            margin-top: 15px;
            display: none;
        }

        .quiz-controls {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 500px;
            margin: auto; /* ç½®ä¸­ */
        }

        .control-btn {
            padding: 12px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            flex: 1;
            margin: 0 10px;
            transition: opacity 0.3s;
        }

        #mastered-btn {
            background-color: #28a745;
        }

        #not-mastered-btn {
            background-color: #dc3545;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quiz-controls-hidden {
            display: none;
        }

        #quiz-status {
            margin-top: 15px;
            font-size: 1.1em;
            color: #6c757d;
        }
        
        /* ç·¨è¼¯ä»‹é¢æ¨£å¼ */
        #edit-page {
            padding: 20px 0;
        }

        #edit-textarea {
            width: 100%;
            min-height: 300px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: monospace;
            font-size: 1em;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        
        #edit-controls {
            display: flex;
            justify-content: space-between;
        }
        
        .edit-control-btn {
            padding: 10px 20px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
        }
        
        #save-edit-btn {
            background-color: #007bff;
        }
        
        #cancel-edit-btn {
            background-color: #6c757d;
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>é–“éš”é‡è¤‡å–®å­—åŠ©æ‰‹</h1>
        </header>

        <div id="home-page">
            <section id="set-management">
                <h3>ğŸ“š å–®å­—é›†ç®¡ç†</h3>
                <div style="display: flex; margin-bottom: 15px;">
                    <input type="text" id="custom-set-input" placeholder="è¼¸å…¥å–®å­—é›†åç¨±æ–°å¢/ç·¨è¼¯">
                    <button id="add-custom-set-btn">æ–°å¢/ç·¨è¼¯</button>
                </div>

                <ul class="word-set-list" id="word-set-list">
                    </ul>
            </section>

            <div id="today-count">
                ä»Šæ—¥å¾…èƒŒå–®å­—: <span id="count-value">0</span>
            </div>

            <button id="start-quiz-btn" disabled>é–‹å§‹èƒŒå–®å­—</button>
        </div>
        
        <div id="quiz-page">
            <h3>ğŸ“ ä»Šæ—¥èƒŒèª¦</h3>
            <div id="quiz-status"></div>
            <div class="word-card" id="word-card">
                <div class="card-front" id="card-front">é»æ“Šé–‹å§‹</div>
                <div class="card-back" id="card-back"></div>
            </div>

            <div class="quiz-controls quiz-controls-hidden" id="quiz-controls">
                <button class="control-btn" id="mastered-btn">æˆ‘ å·² èƒŒ ç†Ÿ ğŸ‘</button>
                <button class="control-btn" id="not-mastered-btn">æˆ‘ é‚„ æ²’ èƒŒ ç†Ÿ</button>
            </div>

            <button class="control-btn" style="background-color: #6c757d; margin-top: 20px;" onclick="goToHomePage()">è¿”å›é¦–é </button>
        </div>

        <div id="edit-page">
            <h3 id="edit-title">âœï¸ ç·¨è¼¯å–®å­—é›†: [åç¨±]</h3>
            <p style="color: #dc3545;">è«‹ä»¥ è‹± æ–‡ = ä¸­ æ–‡ æ ¼å¼è¼¸å…¥ï¼Œæ¯è¡Œä¸€çµ„å–®å­—ã€‚</p>
            <textarea id="edit-textarea"></textarea>
            <div id="edit-controls">
                <button id="save-edit-btn" class="edit-control-btn">å„²å­˜ä¸¦è¿”å›</button>
                <button id="cancel-edit-btn" class="edit-control-btn">å–æ¶ˆ</button>
            </div>
        </div>

    </div>

 <script>
    // DOM å…ƒç´ å¿«å–
    const HOME_PAGE = document.getElementById('home-page');
    const QUIZ_PAGE = document.getElementById('quiz-page');
    const EDIT_PAGE = document.getElementById('edit-page');
    const WORD_SET_LIST = document.getElementById('word-set-list');
    const START_QUIZ_BTN = document.getElementById('start-quiz-btn');
    const COUNT_VALUE = document.getElementById('count-value');
    const CUSTOM_SET_INPUT = document.getElementById('custom-set-input');
    const ADD_CUSTOM_SET_BTN = document.getElementById('add-custom-set-btn');

    const WORD_CARD = document.getElementById('word-card');
    const CARD_FRONT = document.getElementById('card-front');
    const CARD_BACK = document.getElementById('card-back');
    const QUIZ_CONTROLS = document.getElementById('quiz-controls');
    const MASTERED_BTN = document.getElementById('mastered-btn');
    const NOT_MASTERED_BTN = document.getElementById('not-mastered-btn');
    const QUIZ_STATUS = document.getElementById('quiz-status');
    
    const EDIT_TITLE = document.getElementById('edit-title');
    const EDIT_TEXTAREA = document.getElementById('edit-textarea');
    const SAVE_EDIT_BTN = document.getElementById('save-edit-btn');
    const CANCEL_EDIT_BTN = document.getElementById('cancel-edit-btn');

    // --- å–®å­—åˆ—è¡¨ ---

    const defaultSets = {
        'é¾é¨°é«˜ä¸­è‹±æ–‡ç¬¬5èª²(æ¨æ¸¬)': [
            { en: 'preserve', cn: 'ä¿è­·ï¼›ç¶­è­·ï¼ˆå¤è¹Ÿã€å‚³çµ±ï¼‰', mastered: 0, nextReview: 0 },
            { en: 'tradition', cn: 'å‚³çµ±', mastered: 0, nextReview: 0 },
            { en: 'historic', cn: 'æ­·å²æ€§çš„ï¼›æœ‰æ­·å²æ„ç¾©çš„', mastered: 0, nextReview: 0 },
            { en: 'marvel', cn: 'ä»¤äººé©šå¥‡çš„äº‹ç‰©ï¼›å¥‡è¹Ÿ', mastered: 0, nextReview: 0 },
            { en: 'breathtaking', cn: 'ä»¤äººå±æ¯çš„ï¼›æ¥µç¾çš„', mastered: 0, nextReview: 0 },
            { en: 'monument', cn: 'ç´€å¿µç¢‘ï¼›æ­·å²éºè·¡', mastered: 0, nextReview: 0 },
            { en: 'architecture', cn: 'å»ºç¯‰å­¸ï¼›å»ºç¯‰é¢¨æ ¼', mastered: 0, nextReview: 0 },
            { en: 'ancient', cn: 'å¤è€çš„ï¼›å¤ä»£çš„', mastered: 0, nextReview: 0 },
            { en: 'shrine', cn: 'ç¥ç¤¾ï¼›ç¥é¾•', mastered: 0, nextReview: 0 },
            { en: 'temple', cn: 'å¯ºå»Ÿ', mastered: 0, nextReview: 0 },
            { en: 'spiritual', cn: 'ç²¾ç¥ä¸Šçš„ï¼›å¿ƒéˆçš„', mastered: 0, nextReview: 0 },
            { en: 'serenity', cn: 'å¯§éœï¼›å®‰è©³', mastered: 0, nextReview: 0 },
            { en: 'cuisine', cn: 'èœé¤šï¼›çƒ¹é£ªï¼ˆé€šå¸¸æŒ‡é«˜ç´šæˆ–ç‰¹å®šåœ°å€çš„ï¼‰', mastered: 0, nextReview: 0 },
            { en: 'delicate', cn: 'ç²¾ç·»çš„ï¼›æ¸…æ·¡çš„', mastered: 0, nextReview: 0 },
            { en: 'ritual', cn: 'å„€å¼ï¼›æ…£ä¾‹', mastered: 0, nextReview: 0 },
            { en: 'craftsmanship', cn: 'å·¥è—ï¼›æŠ€è—', mastered: 0, nextReview: 0 },
            { en: 'vibrant', cn: 'å……æ»¿æ´»åŠ›çš„ï¼›é®®æ˜çš„', mastered: 0, nextReview: 0 },
            { en: 'harmony', cn: 'å’Œè«§ï¼›å”èª¿', mastered: 0, nextReview: 0 },
            { en: 'embrace', cn: 'æ¥å—ï¼›ä¿¡å¥‰ï¼›æ“æŠ±', mastered: 0, nextReview: 0 },
            { en: 'wander', cn: 'é–’é€›ï¼›æ¼«æ­¥', mastered: 0, nextReview: 0 },
            { en: 'scenic', cn: 'é¢¨æ™¯å„ªç¾çš„', mastered: 0, nextReview: 0 },
            { en: 'authenticity', cn: 'çœŸå¯¦æ€§ï¼›é“åœ°', mastered: 0, nextReview: 0 },
            { en: 'accommodate', cn: 'å®¹ç´', mastered: 0, nextReview: 0 },
            { en: 'negotiation', cn: 'è«‡åˆ¤', mastered: 0, nextReview: 0 },
            { en: 'proposal', cn: 'ææ¡ˆ', mastered: 0, nextReview: 0 }
        ],
        'å¤§å­¸ 6000(æ¸¬è©¦)': [
            { en: 'sustain', cn: 'ç¶­æŒ', mastered: 0, nextReview: 0 },
            { en: 'implement', cn: 'å¯¦æ–½', mastered: 0, nextReview: 0 },
        ]
    };

    // è¨˜æ†¶æ›²ç·šé–“éš”å¤©æ•¸ (ç¬¬ä¸€æ¬¡3å¤©ã€ç¬¬äºŒæ¬¡7å¤©ã€ç¬¬ä¸‰æ¬¡20å¤©ã€ç¬¬å››æ¬¡30å¤©, ä¹‹å¾Œæ¯æ¬¡éƒ½ 100 å¤©)
    const REVIEW_INTERVALS = [3, 7, 20, 30,100]; 

    let wordSets = {}; // æ‰€æœ‰å–®å­—é›†è³‡æ–™
    
    // å¾…èƒŒå–®å­—æ¸…å–®ï¼ˆå–®å­—ç‰©ä»¶ï¼‰ï¼Œç”¨æ–¼è¨ˆç®—æ•¸é‡
    let todayWordsToReview = []; 
    // æ¸¬é©—ä»»å‹™æ¸…å–®ï¼ˆåŒ…å« word å’Œ directionï¼‰
    let todayQuizList = []; 
    // æ–°å¢ï¼šç´€éŒ„æ¯å€‹å–®å­—ä»»å‹™çš„å®Œæˆç‹€æ…‹
    let quizTaskHistory = {}; 
    
    let currentWordIndex = 0; // ç•¶å‰èƒŒèª¦ä»»å‹™åœ¨ todayQuizList ä¸­çš„ç´¢å¼•
    let isAnswerShown = false; // æ˜¯å¦å·²é¡¯ç¤ºç­”æ¡ˆ
    let currentEditingSet = ''; // ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„å–®å­—é›†åç¨±

    // --- ä»‹é¢åˆ‡æ›å‡½æ•¸ ---

    window.goToHomePage = function() { // å°‡å‡½æ•¸æå‡è‡³ window ä½œç”¨åŸŸä»¥ä¾› HTML å‘¼å«
        HOME_PAGE.style.display = 'block';
        QUIZ_PAGE.style.display = 'none';
        EDIT_PAGE.style.display = 'none';
        updateTodayCount(); // å›åˆ°é¦–é é‡æ–°è¨ˆç®—
        CUSTOM_SET_INPUT.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
    }

    function goToQuizPage() {
        HOME_PAGE.style.display = 'none';
        QUIZ_PAGE.style.display = 'block';
        EDIT_PAGE.style.display = 'none';
    }

    function goToEditPage(setName) {
        HOME_PAGE.style.display = 'none';
        QUIZ_PAGE.style.display = 'none';
        EDIT_PAGE.style.display = 'block';

        currentEditingSet = setName;
        EDIT_TITLE.textContent = `âœï¸ ç·¨è¼¯å–®å­—é›†: ${setName}`;

        // è¼‰å…¥ç•¶å‰å–®å­—é›†çš„å…§å®¹
        const currentSet = wordSets[setName] || [];
        const currentList = currentSet
            .filter(w => w.en && w.cn) 
            .map(w => `${w.en.trim()} = ${w.cn.trim()}`)
            .join('\n');

        EDIT_TEXTAREA.value = currentList;
        EDIT_TEXTAREA.focus();
    }


    // --- localStorage å­˜å–å‡½æ•¸ ---

    function saveData() {
        const dataToSave = {};
        Object.keys(wordSets).forEach(setName => {
            // é¿å…ä¿å­˜éé™£åˆ—å±¬æ€§
            if(Array.isArray(wordSets[setName])) {
                dataToSave[setName] = wordSets[setName].map(word => ({
                    en: word.en || '',
                    cn: word.cn || '',
                    mastered: word.mastered || 0,
                    nextReview: word.nextReview || 0,
                })).filter(word => word.en && word.cn);
                // é¡å¤–å„²å­˜ checked ç‹€æ…‹
                dataToSave[setName].checked = wordSets[setName].checked || false; 
            }
        });

        localStorage.setItem('wordSets', JSON.stringify(dataToSave));
        localStorage.setItem('lastLoginDate', getTodayDateString());
    }

    function loadData() {
        const storedSets = localStorage.getItem('wordSets');
        if (storedSets) {
            wordSets = JSON.parse(storedSets);
        }

        // æª¢æŸ¥ä¸¦æ•´åˆé è¨­å–®å­—é›†
        Object.keys(defaultSets).forEach(setName => {
            if (!wordSets[setName] || !Array.isArray(wordSets[setName])) {
                // å¦‚æœæœ¬åœ°æ²’æœ‰ï¼Œå‰‡ä½¿ç”¨é è¨­
                wordSets[setName] = defaultSets[setName].map(word => ({
                    ...word,
                    checked: false,
                }));
            }
            
            // ç¢ºä¿æ‰€æœ‰å–®å­—ç‰©ä»¶éƒ½æœ‰å®Œæ•´å±¬æ€§ï¼Œä¸¦åŠ ä¸Š setName å±¬æ€§æ–¹ä¾¿è¿½è¹¤
            wordSets[setName] = wordSets[setName].map(word => ({
                en: word.en || '',
                cn: word.cn || '',
                mastered: word.mastered || 0,
                nextReview: word.nextReview || 0,
                setName: setName,
            })).filter(word => word.en && word.cn);

            // ç¢ºä¿ checked å±¬æ€§å­˜åœ¨æ–¼é™£åˆ—ä¸Š
            wordSets[setName].checked = (wordSets[setName].checked !== undefined) ? wordSets[setName].checked : false;
        });
        
        const lastLoginDate = localStorage.getItem('lastLoginDate');
        const todayDate = getTodayDateString();

        if (lastLoginDate !== todayDate) {
            refreshReviewStatus(); // è·¨æ—¥é‡è¨­éæœŸå–®å­—çš„ mastered ç‹€æ…‹
        }
    }

    // --- æ—¥æœŸèˆ‡æ™‚é–“å·¥å…· ---

    function getTodayDateString() {
        const date = new Date();
        // å‡è¨­æ¯å¤©æ—©ä¸Š 4 é»é‡ç½®
        if (date.getHours() < 4) { 
            date.setDate(date.getDate() - 1);
        }
        return date.toISOString().split('T')[0];
    }

    function addDaysToDate(days) {
        const date = new Date();
        // å°‡åŸºæº–æ™‚é–“è¨­å®šç‚ºä»Šå¤©çš„ 4AM
        const baseTimestamp = date.setHours(4, 0, 0, 0); 
        const futureDate = new Date(baseTimestamp);
        
        futureDate.setDate(futureDate.getDate() + days);
        
        return futureDate.getTime();
    }
    
    // --- æ ¸å¿ƒé‚è¼¯ï¼šå–®å­—é›†ç®¡ç† ---

    function renderWordSets() {
        WORD_SET_LIST.innerHTML = '';
        const allSetNames = Object.keys(wordSets);

        allSetNames.forEach(setName => {
            const set = wordSets[setName];
            // ç¢ºä¿ set æ˜¯ä¸€å€‹é™£åˆ—
            const wordCount = Array.isArray(set) ? set.length : 0; 
            const isDefault = !!defaultSets[setName];

            const li = document.createElement('li');
            const isChecked = set.checked || false;
            li.innerHTML = `
                <input type="checkbox" id="set-${setName}" data-set-name="${setName}" ${isChecked ? 'checked' : ''}>
                <label for="set-${setName}" class="set-name-display">
                    ${setName} (${wordCount} å€‹å–®å­—) ${isChecked ? 'âœ”ï¸' : ''}
                </label>
                <button class="edit-set-btn" data-set-name="${setName}">ç·¨è¼¯å–®å­—</button>
                ${!isDefault ? `<button class="delete-set-btn" data-set-name="${setName}">åˆªé™¤</button>` : ''}
            `;
            WORD_SET_LIST.appendChild(li);
        });

        document.querySelectorAll('.word-set-list input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', handleSetCheck);
        });
        document.querySelectorAll('.edit-set-btn').forEach(btn => {
            btn.addEventListener('click', (e) => goToEditPage(e.target.dataset.setName));
        });
        document.querySelectorAll('.delete-set-btn').forEach(btn => {
            btn.addEventListener('click', handleDeleteSet);
        });

        updateTodayCount();
    }

    function handleSetCheck(event) {
        const setName = event.target.dataset.setName;
        const isChecked = event.target.checked;

        if (wordSets[setName]) {
            wordSets[setName].checked = isChecked;
            saveData();
            renderWordSets();
        }
    }

    function handleDeleteSet(event) {
        const setName = event.target.dataset.setName;
        if (confirm(`ç¢ºå®šè¦åˆªé™¤å–®å­—é›†ï¼š${setName} å—ï¼Ÿæ­¤æ“ä½œä¸å¯å¾©åŸã€‚`)) {
            delete wordSets[setName];
            saveData();
            renderWordSets();
        }
    }
    
    SAVE_EDIT_BTN.addEventListener('click', () => {
        const setName = currentEditingSet;
        if (!setName) return;

        const newWordsInput = EDIT_TEXTAREA.value;
        const lines = newWordsInput.split('\n');
        const newWords = [];
        const isChecked = wordSets[setName]?.checked || false;

        lines.forEach(line => {
            const trimmedLine = line.trim();
            // ä¿®æ­£ï¼šæ­£è¦è¡¨é”å¼è®“ = å‰å¾Œç©ºç™½å½ˆæ€§æ›´å¤§
            const match = trimmedLine.match(/^(.+?)\s*=\s*(.+)$/); 

            if (match) {
                const en = match[1].trim();
                const cn = match[2].trim();
                
                if (en && cn) {
                    // æª¢æŸ¥å–®å­—æ˜¯å¦å·²å­˜åœ¨ï¼Œä»¥ä¿ç•™é€²åº¦
                    const existingWord = wordSets[setName]?.find(w => w.en === en);
                    
                    newWords.push(existingWord ? 
                        { ...existingWord, cn: cn, setName: setName } : 
                        { en: en, cn: cn, mastered: 0, nextReview: 0, setName: setName }
                    );
                }
            }
        });

        if (newWords.length === 0 && (wordSets[setName]?.length || 0) > 0) {
            if (!confirm('æ‚¨è¼¸å…¥çš„å–®å­—æ¸…å–®æ˜¯ç©ºçš„ï¼Œç¢ºå®šè¦æ¸…ç©ºæ­¤å–®å­—é›†å—ï¼Ÿ')) {
                return;
            }
        }
        
        wordSets[setName] = newWords;
        wordSets[setName].checked = isChecked; 

        saveData();
        alert(`å–®å­—é›†ã€Œ${setName}ã€å·²æ›´æ–°ï¼Œå…±æœ‰ ${newWords.length} å€‹å–®å­—ã€‚`);
        goToHomePage();
    });
    
    CANCEL_EDIT_BTN.addEventListener('click', () => {
        if (confirm('ç¢ºå®šè¦å–æ¶ˆç·¨è¼¯å—ï¼Ÿæ‚¨çš„è®Šæ›´å°‡ä¸æœƒå„²å­˜ã€‚')) {
            goToHomePage();
        }
    });
    
    ADD_CUSTOM_SET_BTN.addEventListener('click', () => {
        const setName = CUSTOM_SET_INPUT.value.trim();
        if (!setName) {
            alert('è«‹è¼¸å…¥å–®å­—é›†åç¨±ï¼');
            return;
        }
        
        if (!wordSets[setName]) {
            wordSets[setName] = [];
            wordSets[setName].checked = false;
        }

        goToEditPage(setName);
    });

    // --- æ ¸å¿ƒé‚è¼¯ï¼šåˆ·æ–°èˆ‡è¨ˆæ•¸ ---

    function refreshReviewStatus() {
        const fourAMTodayTimestamp = new Date().setHours(4, 0, 0, 0); 

        Object.keys(wordSets).forEach(setName => {
            const set = wordSets[setName];
            if (Array.isArray(set)) {
                set.forEach(word => {
                    // å¦‚æœå–®å­—è¨­å®šäº†ä¸‹æ¬¡è¤‡ç¿’æ™‚é–“ï¼Œä¸”è©²æ™‚é–“åœ¨ä»Šå¤©æ—©ä¸Š 4 é»å‰
                    if (word.nextReview > 0 && word.nextReview < fourAMTodayTimestamp) {
                        // å‰‡å°‡å…¶æŒæ¡åº¦é‡è¨­ç‚º 0ï¼Œæ’å…¥ä»Šæ—¥è¤‡ç¿’
                        word.mastered = 0; 
                        word.nextReview = 0;
                    }
                });
            }
        });
        saveData();
    }

    function updateTodayCount() {
        todayWordsToReview = []; // å¾…èƒŒå–®å­—æ¸…å–®ï¼ˆå–®å­—ç‰©ä»¶ï¼‰
        const fourAMTodayTimestamp = new Date().setHours(4, 0, 0, 0);

        Object.keys(wordSets).forEach(setName => {
            const set = wordSets[setName];
            if (Array.isArray(set) && set.checked) {
                set.forEach(word => {
                    // nextReview ç‚º 0 (æ–°å–®å­—) æˆ– nextReview æ™‚é–“æˆ³è¨˜æ—©æ–¼ä»Šå¤©æ—©ä¸Š 4 é» (éœ€è¤‡ç¿’)
                    if (word.nextReview === 0 || word.nextReview < fourAMTodayTimestamp) {
                        todayWordsToReview.push(word);
                    }
                });
            }
        });

        // é¡¯ç¤ºçš„æ˜¯éœ€è¦èƒŒèª¦çš„ã€Œå–®å­—ã€æ•¸é‡
        COUNT_VALUE.textContent = todayWordsToReview.length; 
        START_QUIZ_BTN.disabled = todayWordsToReview.length === 0;
        START_QUIZ_BTN.textContent = todayWordsToReview.length === 0 ? 'ä»Šæ—¥ä»»å‹™å·²å®Œæˆ ğŸ‰ğŸ‰ğŸ‰' : `é–‹å§‹èƒŒå–®å­— (å…± ${todayWordsToReview.length} è©)`;
    }


    // --- æ ¸å¿ƒé‚è¼¯ï¼šèƒŒèª¦ä»‹é¢ ---

    START_QUIZ_BTN.addEventListener('click', startQuiz);

    function startQuiz() {
        if (todayWordsToReview.length === 0) {
            alert('ä»Šæ—¥æ²’æœ‰å–®å­—éœ€è¦èƒŒèª¦ï¼');
            return;
        }
        
        // 1. ç”Ÿæˆé›™å‘æ¸¬é©—ä»»å‹™
        todayQuizList = [];
        quizTaskHistory = {}; // é‡ç½®ä»»å‹™æ­·å²ç´€éŒ„
        
        todayWordsToReview.forEach(word => {
            // è‹± -> ä¸­ ä»»å‹™
            todayQuizList.push({ 
                word: word, 
                isEnglishToChinese: true, 
                key: `${word.setName}-${word.en}-en2cn` 
            }); 
            // ä¸­ -> è‹± ä»»å‹™
            todayQuizList.push({ 
                word: word, 
                isEnglishToChinese: false, 
                key: `${word.setName}-${word.en}-cn2en` 
            });
            // åˆå§‹åŒ–æ¯å€‹å–®å­—åœ¨å…©å€‹æ–¹å‘çš„å®Œæˆç‹€æ…‹
            quizTaskHistory[word.en] = { en2cn: false, cn2en: false, failed: false };
        });
        
        // 2. éš¨æ©Ÿæ’åºä»»å‹™æ¸…å–®
        todayQuizList.sort(() => Math.random() - 0.5);
        
        goToQuizPage();
        currentWordIndex = 0;
        displayCurrentWord();
    }

    function displayCurrentWord() {
        if (currentWordIndex >= todayQuizList.length) {
            // æ¸¬é©—çµæŸ
            CARD_FRONT.textContent = 'ä»Šæ—¥ä»»å‹™å®Œæˆï¼';
            CARD_BACK.textContent = 'é»æ“Šã€Œè¿”å›é¦–é ã€æŸ¥çœ‹é€²åº¦';
            CARD_BACK.style.display = 'block';
            QUIZ_CONTROLS.classList.add('quiz-controls-hidden');
            QUIZ_STATUS.textContent = `å·²å®Œæˆæ‰€æœ‰ ${todayWordsToReview.length * 2} å€‹ä»»å‹™ï¼`; 
            saveData(); // æœ€å¾Œå„²å­˜ä¸€æ¬¡
            return;
        }

        const currentTask = todayQuizList[currentWordIndex];
        const currentWord = currentTask.word;
        const isEnglishToChinese = currentTask.isEnglishToChinese; 

        // æ ¹æ“šæ–¹å‘è¨­ç½®å¡ç‰‡å…§å®¹
        CARD_FRONT.textContent = isEnglishToChinese ? currentWord.en : currentWord.cn;
        CARD_BACK.textContent = isEnglishToChinese ? currentWord.cn : currentWord.en;
        CARD_BACK.style.display = 'none';
        QUIZ_CONTROLS.classList.add('quiz-controls-hidden');
        isAnswerShown = false;
        
        // é¡¯ç¤ºç‹€æ…‹
        const directionText = isEnglishToChinese ? 'è‹±â†’ä¸­' : 'ä¸­â†’è‹±';
        QUIZ_STATUS.textContent = `ä»»å‹™: ${currentWordIndex + 1} / ${todayQuizList.length} (${directionText} | å–®å­—é›†: ${currentWord.setName}) - ç­‰ç´š: ${currentWord.mastered}`;
    }

    // é»æ“Šå¡ç‰‡é¡¯ç¤ºç­”æ¡ˆ
    WORD_CARD.addEventListener('click', () => {
        if (!isAnswerShown && currentWordIndex < todayQuizList.length) {
            CARD_BACK.style.display = 'block';
            QUIZ_CONTROLS.classList.remove('quiz-controls-hidden');
            isAnswerShown = true;
        }
    });

    MASTERED_BTN.addEventListener('click', () => handleQuizResult(true));
    NOT_MASTERED_BTN.addEventListener('click', () => handleQuizResult(false));

    function handleQuizResult(isMastered) {
        if (!isAnswerShown) return;

        const currentTask = todayQuizList[currentWordIndex];
        const currentWord = currentTask.word; // å¾…è¤‡ç¿’æ¸…å–®ä¸­çš„å–®å­—ç‰©ä»¶
        const wordKey = currentWord.en;
        const direction = currentTask.isEnglishToChinese ? 'en2cn' : 'cn2en';

        // 1. è™•ç†å–®å­—é€²åº¦æ›´æ–° (åœ¨åŸå§‹ wordSets å…§æ›´æ–°)
        const originalSet = wordSets[currentWord.setName];
        const originalWordIndex = originalSet?.findIndex(w => w.en === wordKey);

        if (originalWordIndex !== -1) {
            const word = originalSet[originalWordIndex];
            
            if (!isMastered) {
                // åªè¦ä»»ä¸€æ–¹å‘ã€Œæ²’èƒŒç†Ÿã€ï¼Œå‰‡å°‡è©²å–®å­—é€²åº¦é‡è¨­ï¼Œä¸¦è¨­ç½®ç‚ºæ˜å¤©è¤‡ç¿’ (é–“éš” 1 å¤©)
                word.mastered = 0; 
                word.nextReview = addDaysToDate(1);
                quizTaskHistory[wordKey].failed = true; // æ¨™è¨˜ç‚ºå¤±æ•—
                
            } 
            
            // 2. æ›´æ–°ä»»å‹™æ­·å²
            if (isMastered) {
                quizTaskHistory[wordKey][direction] = true;
            }
            
            // 3. æª¢æŸ¥å–®å­—æ˜¯å¦å·²å®Œæˆé›™å‘è¤‡ç¿’ (åƒ…åœ¨éå¤±æ•—ä¸”é›™å‘éƒ½æˆåŠŸæ™‚æ‰å‡ç´š)
            const history = quizTaskHistory[wordKey];
            if (!history.failed && history.en2cn && history.cn2en) {
                // é›™å‘éƒ½æˆåŠŸä¸”æ²’å¤±æ•—éï¼Œå‰‡æå‡ç­‰ç´š
                word.mastered = Math.min(word.mastered + 1, REVIEW_INTERVALS.length);
                const days = REVIEW_INTERVALS[word.mastered - 1] || REVIEW_INTERVALS[REVIEW_INTERVALS.length - 1]; // ç¢ºä¿è¶…éé•·åº¦æ™‚ä»ä½¿ç”¨æœ€é•·é–“éš”
                word.nextReview = addDaysToDate(days);
                
                // å°‡è©²å–®å­—å¾ä»Šæ—¥å¾…èƒŒæ¸…å–®ä¸­ç§»é™¤ï¼ˆé›–ç„¶åŠŸèƒ½ä¸Šä¸¦éå¿…è¦ï¼Œä½†å¯ä»¥ä¿æŒé‚è¼¯æ¸…æ™°ï¼‰
                const todayIndex = todayWordsToReview.findIndex(w => w.en === wordKey);
                if (todayIndex !== -1) {
                    todayWordsToReview.splice(todayIndex, 1);
                }
            }
            
            originalSet[originalWordIndex] = word;
            
            // åŒæ­¥æ›´æ–°ç•¶å‰ä»»å‹™ä¸­çš„ word ç‰©ä»¶ (ä¿æŒä¸€è‡´æ€§)
            currentTask.word = word; 
        }

        // 4. ç„¡è«–èƒŒç†Ÿèˆ‡å¦ï¼Œéƒ½ç§»è‡³ä¸‹ä¸€å€‹ä»»å‹™
        currentWordIndex++;
        saveData();
        displayCurrentWord();
    }

    // --- åˆå§‹åŒ– ---

    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        renderWordSets();
        goToHomePage(); 
    });
</script>


</body>
</html>


